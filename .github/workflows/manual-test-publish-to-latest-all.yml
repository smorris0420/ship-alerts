name: Manual Publish or Restore latest-all.xml

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose Publish (write test) or RestorePrevious (copy latest.xml to latest-all.xml)"
        required: true
        type: choice
        options: [Publish, RestorePrevious]
        default: Publish
      ship:
        description: "Ship name (e.g., Disney Wonder)"
        required: false
        type: string
      event:
        description: "Event"
        required: false
        type: choice
        options: [Arrived, Departed]
      port:
        description: "Port (e.g., Melbourne, Australia)"
        required: false
        type: string
      est:
        description: "EST label (e.g., Nov 08, 01:57 PM EST)"
        required: false
        type: string
      local:
        description: "Local time label (optional)"
        required: false
        type: string
        default: ""
      link:
        description: "Detail link (optional)"
        required: false
        type: string
        default: "#"
      filename:
        description: "Target filename in docs/ (default latest-all.xml)"
        required: false
        type: string
        default: "latest-all.xml"
      also_underscore:
        description: "Also write/restore docs/latest_all.xml"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  publish-or-restore:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ---------- Publish ----------
      - name: Install Python
        if: ${{ inputs.mode == 'Publish' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run publisher (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          python .github/scripts/publish_latest_all.py \
            --ship "${{ inputs.ship }}" \
            --event "${{ inputs.event }}" \
            --port "${{ inputs.port }}" \
            --est "${{ inputs.est }}" \
            --local "${{ inputs.local }}" \
            --link "${{ inputs.link }}" \
            --filename "${{ inputs.filename }}" \
            $([ "${{ inputs.also_underscore }}" = "true" ] && echo "--also-underscore")

      - name: Commit publish
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          set -e
          FILE="docs/${{ inputs.filename }}"
          git add "$FILE"
          if [ "${{ inputs.also_underscore }}" = "true" ]; then
            git add docs/latest_all.xml || true
          fi
          git commit -m "manual publish: ${{ inputs.ship }} ${{ inputs.event }} at ${{ inputs.port }}" || echo "No changes to commit"
          git push || echo "No changes pushed"

      # ---------- Restore (copy latest.xml -> latest-all.xml) ----------
      - name: Restore from latest.xml (RestorePrevious mode)
        if: ${{ inputs.mode == 'RestorePrevious' }}
        env:
          DEST_FILE: docs/${{ inputs.filename }}
          SRC_FILE: docs/latest.xml
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -e
          echo "Source:  $SRC_FILE"
          echo "Dest:    $DEST_FILE"

          if [ ! -f "$SRC_FILE" ]; then
            echo "ERROR: $SRC_FILE not found. Cannot restore."
            exit 1
          fi

          mkdir -p "$(dirname "$DEST_FILE")"
          cp "$SRC_FILE" "$DEST_FILE"

          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            cp "$SRC_FILE" docs/latest_all.xml
            git add docs/latest_all.xml
            echo "Also restored docs/latest_all.xml from latest.xml."
          fi

          git add "$DEST_FILE"
          git commit -m "restore: copy latest.xml -> $DEST_FILE" || echo "No changes to commit"
          git push || echo "No changes pushed"
          echo "Restore complete."
