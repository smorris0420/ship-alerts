      - name: Notify Power Automate (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        env:
          FLOW_URL: ${{ secrets.FLOW_URL }}
          FLOW_SECRET: ${{ secrets.FLOW_SECRET }}
          SHIP: ${{ inputs.ship }}
          EVENT: ${{ inputs.event }}          # Arrived | Departed
          PORT: ${{ inputs.port }}
          EST: ${{ inputs.est }}
          LOCAL: ${{ inputs.local }}
          LINK: ${{ inputs.link }}
        run: |
          set -euo pipefail

          if [ -z "${FLOW_URL:-}" ] || [ -z "${FLOW_SECRET:-}" ]; then
            echo "::warning ::FLOW_URL or FLOW_SECRET not set; skipping webhook notify."
            exit 0
          fi

          if [ "${EVENT}" = "Arrived" ]; then
            VERB_PHRASE="Arrived at"
          else
            VERB_PHRASE="Departed from"
          fi

          TITLE="${SHIP} ${VERB_PHRASE} ${PORT} at ${EST}"
          if [ -n "${LOCAL}" ]; then
            TITLE="${TITLE}. The local time to the port is ${LOCAL}"
          fi

          # Stable GUID based on the manual publish tuple
          GUID="$(python - <<'PY'
import hashlib, os
ship=os.environ['SHIP']; event=os.environ['EVENT']; port=os.environ['PORT']; est=os.environ['EST']
print(hashlib.sha1(f"manual|{ship}|{event}|{port}|{est}".encode()).hexdigest())
PY
)"

          PUB="$(date -u -R)"   # RFC 2822 (e.g., Sun, 09 Nov 2025 12:34:56 +0000)

          # Build JSON payload safely (no heredoc interpolation issues)
          tmp=$(mktemp)
          python - "$tmp" <<'PY'
import json, os, sys
out = {
  "ShipName":   os.environ["SHIP"],
  "EventType":  os.environ["EVENT"],
  "PortName":   os.environ["PORT"],
  "ESTLabel":   os.environ["EST"],
  "LocalLabel": os.environ.get("LOCAL",""),
  "Link":       os.environ.get("LINK","#"),
  "Title":      "",   # let Flow rebuild or accept this string if desired
  "GuidKey":    os.environ["GUID"],
  "PubDate":    os.environ["PUB"],
  "Description": ""
}
# If you want Title passed through, uncomment next line:
out["Title"] = os.environ["SHIP"] + (" Arrived at " if os.environ["EVENT"]=="Arrived" else " Departed from ") + os.environ["PORT"] + " at " + os.environ["EST"] + ((". The local time to the port is " + os.environ["LOCAL"]) if os.environ.get("LOCAL") else "")
with open(sys.argv[1], "w", encoding="utf-8") as f:
    json.dump(out, f, ensure_ascii=False)
PY

          echo "Posting webhook for ${SHIP} ${EVENT} @ ${PORT}"
          http_code=$(curl -sS -o /tmp/flow_resp.txt -w "%{http_code}" \
            -X POST "$FLOW_URL" \
            -H "Content-Type: application/json" \
            -H "x-shipalerts-secret: $FLOW_SECRET" \
            --data-binary @"$tmp")

          echo "Flow response code: ${http_code}"
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "---- Flow response body ----"
            cat /tmp/flow_resp.txt || true
            echo "----------------------------"
            exit 1
          fi
