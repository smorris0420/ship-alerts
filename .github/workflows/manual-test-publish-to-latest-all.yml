name: Manual Publish or Restore

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose Publish (write test) or RestorePrevious (copy latest.xml -> latest-all.xml)"
        required: true
        type: choice
        options: [Publish, RestorePrevious]
        default: Publish
      ship:
        description: "Ship name (e.g., Disney Wonder)"
        required: false
        type: string
      event:
        description: "Event"
        required: false
        type: choice
        options: [Arrived, Departed]
      port:
        description: "Port (e.g., Melbourne, Australia)"
        required: false
        type: string
      est:
        description: "EST label (e.g., Nov 08, 01:57 PM EST)"
        required: false
        type: string
      local:
        description: "Local time label (optional)"
        required: false
        type: string
        default: ""
      link:
        description: "Detail link (optional)"
        required: false
        type: string
        default: "#"
      filename:
        description: "Target filename in docs/ (default latest-all.xml)"
        required: false
        type: string
        default: "latest-all.xml"
      also_underscore:
        description: "Also write/restore docs/latest_all.xml"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  publish-or-restore:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        shell: bash
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Mark workspace as safe to avoid safety checks that can block commits
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # ---------- Publish ----------
      - name: Validate inputs (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        shell: bash
        run: |
          set -e
          if [ -z "${{ inputs.ship }}" ] || [ -z "${{ inputs.event }}" ] || [ -z "${{ inputs.port }}" ] || [ -z "${{ inputs.est }}" ]; then
            echo "Missing one or more required inputs: ship, event, port, est"
            exit 1
          fi

      - name: Install Python
        if: ${{ inputs.mode == 'Publish' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run publisher (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        shell: bash
        env:
          TARGET_FILE: docs/${{ inputs.filename }}
        run: |
          set -euo pipefail
          echo "Writing to: $TARGET_FILE"
          python .github/scripts/publish_latest_all.py \
            --ship "${{ inputs.ship }}" \
            --event "${{ inputs.event }}" \
            --port "${{ inputs.port }}" \
            --est "${{ inputs.est }}" \
            --local "${{ inputs.local }}" \
            --link "${{ inputs.link }}" \
            --filename "${{ inputs.filename }}" \
            --nonce "${{ github.run_id }}" \
            $([ "${{ inputs.also_underscore }}" = "true" ] && echo "--also-underscore")

          echo "---- HEAD of file after write ----"
          sed -n '1,80p' "$TARGET_FILE" || true
          echo "----------------------------------"

      - name: Commit publish (only if changed)
        if: ${{ inputs.mode == 'Publish' }}
        shell: bash
        env:
          TARGET_FILE: docs/${{ inputs.filename }}
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -euo pipefail

          # Make sure we're up-to-date and avoid non-fast-forward
          git fetch --all
          # $GITHUB_REF_NAME is available on GH-hosted runners
          CURRENT_BRANCH="${GITHUB_REF_NAME:-$(git rev-parse --abbrev-ref HEAD)}"
          git checkout "$CURRENT_BRANCH"
          git pull --rebase origin "$CURRENT_BRANCH" || true

          # Prime diff for new files as well
          git add -N "$TARGET_FILE" 2>/dev/null || true
          if [ "${ALSO_UNDERSCORE}" = "true" ]; then
            git add -N docs/latest_all.xml 2>/dev/null || true
          fi

          CHANGES=0
          if ! git diff --quiet -- "$TARGET_FILE"; then
            CHANGES=1
          fi
          if [ "${ALSO_UNDERSCORE}" = "true" ] && [ -f docs/latest_all.xml ]; then
            if ! git diff --quiet -- "docs/latest_all.xml"; then
              CHANGES=1
            fi
          fi

          if [ "$CHANGES" -eq 0 ]; then
            echo "::notice ::No changes detected; skipping commit."
            exit 0
          fi

          git add "$TARGET_FILE"
          if [ "${ALSO_UNDERSCORE}" = "true" ] && [ -f docs/latest_all.xml ]; then
            git add docs/latest_all.xml
          fi

          git commit -m "manual publish: ${{ inputs.ship }} ${{ inputs.event }} at ${{ inputs.port }}"
          git push origin "$CURRENT_BRANCH"
          echo "Publish committed & pushed."

      - name: Notify Power Automate (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        shell: bash
        env:
          FLOW_URL: ${{ secrets.FLOW_URL }}
          FLOW_SECRET: ${{ secrets.FLOW_SECRET }}
          SHIP: ${{ inputs.ship }}
          EVENT: ${{ inputs.event }}
          PORT: ${{ inputs.port }}
          EST: ${{ inputs.est }}
          LOCAL: ${{